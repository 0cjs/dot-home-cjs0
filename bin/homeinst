#!/usr/bin/env bash
#
#   homeinst - install stuff in homedir
#
set -o pipefail

die() { echo 2>&1 "$(basename "$0"):" "$@"; exit 1; }

homeinst_nodejs() {
    # Filename format: node-v8.9.4-linux-x64.tar.xz
    local url=$(
        curl -s https://nodejs.org/en/download/ \
        | sed -ne 's/.*"\(https:[^"]*-linux-x64[^"]*\)".*/\1/p'
        )
    [[ -n $url ]] || die "Can't find latest stable nodejs version"
    local filename="$(basename "$url")"
    local version="${filename#node-}"
          version="${version%%-*}"
    echo "Latest version: $version"
    [[ $(node --version) = $version ]] && { echo "No update needed."; return; }
    local tarball=~/Downloads/"$filename"
    if [[ -r $tarball ]]; then
        echo "Skipping download; found $tarball"
    else
        curl --create-dirs -o "$tarball" "$url"
    fi
    cd ~/.local/ || die "Can't cd ~/.local/"
    tar --strip-components=1 -xf "$tarball"
}

homeinst_pip() {
    local req=python3-distutils     # required only on Debian 11
    #   Cannot use grep -q here because it fails with 141 (pipe broken?)
    if  apt-cache pkgnames $req | grep "^$req\$" >/dev/null \
        && ! dpkg -s $req >/dev/null
    then
        sudo apt-get install $req
    fi

    local getpip=~/Downloads/get-pip.py
    curl --create-dirs -o "$getpip" https://bootstrap.pypa.io/get-pip.py
    python3 "$getpip" --user
}

homeinst_pythonz() {
    curl -kL https://raw.github.com/saghul/pythonz/master/pythonz-install | bash
}

if [[ $(type -t homeinst_$1) == function ]]; then
    homeinst_$1
else
    die "Unknown application: $1"
fi
